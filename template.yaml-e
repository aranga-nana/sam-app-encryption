AWSTemplateFormatVersion: 2010-09-09
Description: >-
  sam-app
Transform:
- AWS::Serverless-2016-10-31

Parameters:
  SNSTopicArn:
    Type: String
    Description: The ARN of the SNS topic for the environment.

  LambdaExecutionRoleArn:
    Type: String
    Description: The ARN of the IAM role that the Lambda function will assume.

  AUTH_ID:
    Type: String
    Description: The authentication ID for the environment.

Resources:
  RootCertsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: Layer to store root certificates for RESTful API access
      ContentUri: ./certs-layer
      CompatibleRuntimes:
        - nodejs20.x

  SNSPayloadLogger:
    Type: AWS::Serverless::Function
    Properties:
      Description: A Lambda function that logs the payload of messages sent to an
        associated SNS topic.
      Runtime: nodejs20.x
      Handler: handlers/app.handler
      CodeUri: ./dist
      Role: !Ref LambdaExecutionRoleArn  # Pass the role ARN here
      Layers:
        - !Ref RootCertsLayer
      Environment:
        Variables:
          AUTH_SECRET: "AQICAHjq7bQ8Cv+95r3Wh19xD45CLyVa5jBOjoE2raeFf3G1LQHdhJk5mtwY30hWU5a4R1wkAAAAcDBuBgkqhkiG9w0BBwagYTBfAgEAMFoGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMOv4Yk47MJ6f96e9yAgEQgC0YtKVWKQ0gAJjlhC3eTUP5BDpz7Fl3yuDFWFYo5PvuPsltADZtXdl5PK8u9SQ="
          AUTH_ID: !Ref AUTH_ID
      Events:
        SNSTopicEvent:
          Type: SNS
          Properties:
            Topic: !Ref SNSTopicArn
      MemorySize: 128
      Timeout: 100
      Policies:
        - AWSLambdaBasicExecutionRole
